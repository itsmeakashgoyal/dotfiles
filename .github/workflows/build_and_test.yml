---
name: Test Dotfiles Setup

"on":
  push:
    branches: ["master", "main"]
    paths:
      - ".github/workflows/build_and_test*.yml"
      - "install.sh"
      - "bootstrap.sh"
      - "scripts/**"
      - "packages/**"
      - "zsh/**"
      - "nvim/**"
      - "tmux/**"
  pull_request:
    branches: ["master", "main"]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: "Enable debug mode"
        required: false
        default: "false"

# Security: Define minimal permissions
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Lint and validate scripts
  lint:
    name: Lint Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Cache shellcheck
        uses: actions/cache@v4
        with:
          path: ~/bin
          key: shellcheck-${{ runner.os }}

      - name: Install shellcheck
        run: |
          if ! command -v shellcheck &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y shellcheck
          fi

      - name: Run shellcheck on all scripts
        run: |
          echo "üîç Checking bash/shell scripts..."
          find . -type f \( -name "*.sh" -o -name "dutils" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            -exec shellcheck -x {} + || echo "‚ö†Ô∏è  Shellcheck found issues"

      - name: Check file permissions
        run: |
          echo "üîê Checking executable permissions..."
          scripts="install.sh bootstrap.sh scripts/**/*.sh scripts/utils/dutils"
          for script in $scripts; do
            if [[ -f "$script" ]] && [[ ! -x "$script" ]]; then
              echo "‚ùå Missing execute permission: $script"
              exit 1
            fi
          done
          echo "‚úÖ All scripts have correct permissions"

      - name: Validate YAML files
        run: |
          sudo apt-get install -y yamllint
          yamllint .github/workflows/*.yml || true

  # Job 2: Test on macOS
  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    timeout-minutes: 30
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display system info
        run: |
          echo "üñ•Ô∏è  System Information"
          echo "===================="
          uname -a
          sw_vers
          echo "Shell: $SHELL"
          echo "Home: $HOME"
          df -h

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /usr/local/Homebrew
          key: ${{ runner.os }}-brew-${{ hashFiles('**/Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Setup dotfiles directory
        run: |
          echo "üìÅ Setting up dotfiles directory..."
          mkdir -p "$HOME/dotfiles"
          rsync -av --exclude='.git' . "$HOME/dotfiles/"
          ls -la "$HOME/dotfiles"

      - name: Make scripts executable
        run: |
          cd "$HOME/dotfiles"
          echo "üîß Making scripts executable..."
          chmod +x install.sh bootstrap.sh
          find scripts -type f -name "*.sh" -exec chmod +x {} +
          chmod +x scripts/utils/dutils

      - name: Run dotfiles installation
        run: |
          cd "$HOME/dotfiles"
          export CI=1
          export DOTFILES_TEST=1
          echo "üöÄ Running dotfiles installation..."
          echo "y" | ./install.sh
        continue-on-error: false

      - name: Verify installation
        run: |
          echo "‚úÖ Verifying installation..."

          # Configure Homebrew PATH for macOS
          if [[ -x "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [[ -x "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi

          # Check if Homebrew is installed
          if ! command -v brew &> /dev/null; then
            echo "‚ùå Homebrew not found"
            exit 1
          else
            echo "‚úÖ Homebrew installed: $(brew --version | head -n1)"
          fi

          # Check if zsh is installed
          if ! command -v zsh &> /dev/null; then
            echo "‚ùå zsh not found"
            exit 1
          fi

          # Check core packages from Brewfile
          echo "üîç Checking core packages..."
          # Check using actual binary names (format: "binary:package_name")
          # Compatible with Bash 3.2+ (macOS default)
          packages=(
            "bat:bat"
            "eza:eza"
            "fzf:fzf"
            "rg:ripgrep"
            "nvim:neovim"
            "delta:git-delta"
            "lazygit:lazygit"
          )
          failed=0
          for pkg in "${packages[@]}"; do
            binary="${pkg%%:*}"
            name="${pkg##*:}"
            if command -v "$binary" &> /dev/null; then
              echo "  ‚úÖ $name"
            else
              echo "  ‚ö†Ô∏è  $name not found"
              ((failed++))
            fi
          done

          if [[ $failed -gt 3 ]]; then
            echo "‚ùå Too many packages missing ($failed)"
            exit 1
          fi

          # Check if zinit was installed
          if [[ ! -d "$HOME/.local/share/zinit" ]]; then
            echo "‚ö†Ô∏è  zinit not installed"
          fi

          # Check if symlinks were created
          if [[ -L "$HOME/.zshenv" ]]; then
            echo "‚úÖ .zshenv symlinked"
          else
            echo "‚ö†Ô∏è  .zshenv not symlinked"
          fi

          # Check if dutils is accessible
          if [[ -f "$HOME/.local/bin/dutils" ]]; then
            echo "‚úÖ dutils installed"
            "$HOME/.local/bin/dutils" version || true
          fi

          echo "‚úÖ Installation verified successfully"

      - name: Test zsh configuration
        shell: zsh {0}
        run: |
          echo "üß™ Testing zsh configuration..."
          
          # Configure Homebrew PATH for macOS
          if [[ -x "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [[ -x "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          
          # Source the zsh config
          export ZDOTDIR="$HOME/dotfiles/zsh"
          source "$HOME/.zshenv" || echo "‚ö†Ô∏è  Could not source .zshenv"

          # Test if basic commands work
          echo "Testing basic commands..."
          type l ll gs gco 2>/dev/null || echo "Some aliases not loaded"

          echo "‚úÖ Zsh configuration test complete"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-logs
          path: |
            /tmp/setup_log.txt
          retention-days: 7

  # Job 3: Test on Ubuntu
  test-ubuntu:
    name: Test on Ubuntu
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display system info
        run: |
          echo "üñ•Ô∏è  System Information"
          echo "===================="
          uname -a
          lsb_release -a
          echo "Shell: $SHELL"
          echo "Home: $HOME"
          df -h

      - name: Cache APT packages
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            ~/.cache
          key: ${{ runner.os }}-apt-${{ hashFiles('**/Brewfile') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install ZSH
        run: |
          echo "üì¶ Installing zsh..."
          sudo apt-get update -qq
          sudo apt-get install -y zsh git curl
          zsh --version

      - name: Setup dotfiles directory
        run: |
          echo "üìÅ Setting up dotfiles directory..."
          mkdir -p "$HOME/dotfiles"
          rsync -av --exclude='.git' . "$HOME/dotfiles/"
          ls -la "$HOME/dotfiles"

      - name: Make scripts executable
        run: |
          cd "$HOME/dotfiles"
          echo "üîß Making scripts executable..."
          chmod +x install.sh bootstrap.sh
          find scripts -type f -name "*.sh" -exec chmod +x {} +
          chmod +x scripts/utils/dutils

      - name: Run dotfiles installation
        run: |
          cd "$HOME/dotfiles"
          export CI=1
          export DOTFILES_TEST=1
          echo "üöÄ Running dotfiles installation..."
          echo "y" | ./install.sh
        continue-on-error: false

      - name: Verify installation
        run: |
          echo "‚úÖ Verifying installation..."

          # Configure Homebrew PATH for Linux
          if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          fi

          # Check if Homebrew is installed
          if ! command -v brew &> /dev/null; then
            echo "‚ùå Homebrew not found"
            exit 1
          else
            echo "‚úÖ Homebrew installed: $(brew --version | head -n1)"
          fi

          # Check if zsh is installed
          zsh --version || exit 1

          # Check core packages from Brewfile
          echo "üîç Checking core packages..."
          # Check using actual binary names (format: "binary:package_name")
          # Compatible with Bash 3.2+ (macOS default)
          packages=(
            "bat:bat"
            "eza:eza"
            "fzf:fzf"
            "rg:ripgrep"
            "nvim:neovim"
            "delta:git-delta"
            "lazygit:lazygit"
          )
          failed=0
          for pkg in "${packages[@]}"; do
            binary="${pkg%%:*}"
            name="${pkg##*:}"
            if command -v "$binary" &> /dev/null; then
              echo "  ‚úÖ $name"
            else
              echo "  ‚ö†Ô∏è  $name not found"
              ((failed++))
            fi
          done

          if [[ $failed -gt 3 ]]; then
            echo "‚ùå Too many packages missing ($failed)"
            exit 1
          fi

          # Check if zinit was installed
          if [[ ! -d "$HOME/.local/share/zinit" ]]; then
            echo "‚ö†Ô∏è  zinit not installed"
          fi

          # Check if symlinks were created
          if [[ -L "$HOME/.zshenv" ]]; then
            echo "‚úÖ .zshenv symlinked"
          else
            echo "‚ö†Ô∏è  .zshenv not symlinked"
          fi

          # Check if dutils is accessible
          if [[ -f "$HOME/.local/bin/dutils" ]]; then
            echo "‚úÖ dutils installed"
            "$HOME/.local/bin/dutils" version || true
          fi

          echo "‚úÖ Installation verified successfully"

      - name: Test zsh configuration
        shell: zsh {0}
        run: |
          echo "üß™ Testing zsh configuration..."
          
          # Configure Homebrew PATH for Linux
          if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          fi
          
          export ZDOTDIR="$HOME/dotfiles/zsh"
          source "$HOME/.zshenv" || echo "‚ö†Ô∏è  Could not source .zshenv"

          echo "Testing basic commands..."
          type l ll 2>/dev/null || echo "Some aliases not loaded"

          echo "‚úÖ Zsh configuration test complete"

      - name: Test dutils commands
        if: always()
        run: |
          echo "üß™ Testing dutils commands..."
          
          # Configure Homebrew PATH for Linux
          if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          fi
          
          export PATH="$HOME/.local/bin:$PATH"

          dutils help || echo "dutils help failed"
          dutils version || echo "dutils version failed"
          dutils detect-os || echo "dutils detect-os failed"
          dutils list-functions || echo "dutils list-functions failed"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-logs
          path: |
            /tmp/setup_log.txt
          retention-days: 7

  # Job 4: Summary and notification
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, test-macos, test-ubuntu]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "üìä Test Summary"
          echo "=============="
          echo "Lint: ${{ needs.lint.result }}"
          echo "macOS: ${{ needs.test-macos.result }}"
          echo "Ubuntu: ${{ needs.test-ubuntu.result }}"

          if [[ "${{ needs.lint.result }}" == "success" ]] && \
             [[ "${{ needs.test-macos.result }}" == "success" ]] && \
             [[ "${{ needs.test-ubuntu.result }}" == "success" ]]; then
            echo "‚úÖ All tests passed!"
            exit 0
          else
            echo "‚ùå Some tests failed"
            exit 1
          fi
